/*
 * game.c
 *
 * Created: 22.01.2023 3:22:14
 *  Author: msi
 */
#include <stdio.h>

#include <avr/eeprom.h>

#include "button.h"
#include "ssd1306.h"
#include "game.h"

const uint8_t game_over_bmp[] =
	{
		// 'game_over', 128x64px
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00,
		0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00,
		0x00, 0x00, 0x60, 0x18, 0x03, 0x0e, 0x10, 0x04, 0x30, 0x02, 0x10, 0xc0, 0x30, 0x04, 0x00, 0x00,
		0x00, 0x00, 0xc0, 0x18, 0x03, 0x0e, 0x10, 0x04, 0x30, 0x02, 0x10, 0xc0, 0x38, 0x06, 0x00, 0x00,
		0x00, 0x00, 0xc0, 0x18, 0x03, 0x00, 0x10, 0x04, 0x30, 0x03, 0x10, 0xc0, 0x18, 0x06, 0x00, 0x00,
		0x00, 0x00, 0x87, 0xf8, 0xc7, 0x00, 0x10, 0xfc, 0x30, 0xc3, 0x10, 0xc3, 0xf8, 0x42, 0x00, 0x00,
		0x00, 0x01, 0x84, 0x18, 0x86, 0x00, 0x10, 0x04, 0x30, 0xc3, 0x08, 0xe0, 0x18, 0x43, 0x00, 0x00,
		0x00, 0x01, 0x88, 0x30, 0x86, 0x00, 0x10, 0x04, 0x30, 0xe1, 0x08, 0xe0, 0x1c, 0x03, 0x00, 0x00,
		0x00, 0x01, 0x08, 0x30, 0x06, 0x00, 0x30, 0x04, 0x30, 0xe1, 0x08, 0x60, 0x0c, 0x03, 0x00, 0x00,
		0x00, 0x03, 0x0e, 0x30, 0x06, 0x10, 0x30, 0xfc, 0x30, 0xe1, 0x08, 0x61, 0xfc, 0x21, 0x80, 0x00,
		0x00, 0x03, 0x00, 0x30, 0x06, 0x1c, 0x30, 0x0c, 0x30, 0x01, 0x08, 0x60, 0x0c, 0x21, 0x80, 0x00,
		0x00, 0x03, 0x00, 0x70, 0x8e, 0x1c, 0x30, 0x04, 0x30, 0x01, 0x80, 0xe0, 0x0c, 0x21, 0x80, 0x00,
		0x00, 0x03, 0x00, 0x61, 0x0e, 0x1c, 0x30, 0x0c, 0x30, 0x01, 0x80, 0xf0, 0x0e, 0x10, 0x80, 0x00,
		0x00, 0x03, 0x00, 0x61, 0x0c, 0x3c, 0x20, 0x0c, 0x10, 0x01, 0xc0, 0xf0, 0x06, 0x10, 0xc0, 0x00,
		0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00,
		0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00,
		0x00, 0x00, 0x3e, 0x00, 0x00, 0x00, 0x1f, 0xc0, 0x01, 0xf8, 0x00, 0x03, 0xc0, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x1f, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xf0,
		0x24, 0x84, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xb4, 0x10,
		0x24, 0x9c, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x94, 0x90,
		0x21, 0x84, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x86, 0xd0,
		0x33, 0x3f, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x82, 0xc8,
		0x13, 0x08, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x52, 0x48,
		0x13, 0x08, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5a, 0x08,
		0x1f, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xf8,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x00,
		0x00, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x06, 0x00,
		0x00, 0x20, 0x08, 0x00, 0x1f, 0xf1, 0xfe, 0x61, 0xf7, 0xff, 0xff, 0xff, 0x80, 0x04, 0x01, 0x00,
		0x00, 0x43, 0x84, 0x00, 0x20, 0x92, 0x19, 0x92, 0x0c, 0x30, 0x49, 0x30, 0xc0, 0x08, 0xf0, 0x80,
		0x00, 0x42, 0x84, 0x00, 0x21, 0x92, 0x19, 0x92, 0x08, 0x10, 0x49, 0xb0, 0x40, 0x08, 0x88, 0x80,
		0x00, 0x44, 0x44, 0x00, 0x41, 0x94, 0x19, 0x12, 0x48, 0xf2, 0x4c, 0x96, 0x40, 0x08, 0xf0, 0x80,
		0x00, 0x47, 0xc4, 0x00, 0x41, 0x94, 0x9c, 0x32, 0x48, 0x12, 0x44, 0x1e, 0x40, 0x08, 0x88, 0x80,
		0x00, 0x44, 0x44, 0x00, 0x4f, 0x3c, 0x1c, 0x62, 0x08, 0x90, 0x44, 0x0c, 0x40, 0x08, 0xf0, 0x80,
		0x00, 0x78, 0x3c, 0x00, 0x4f, 0x3c, 0x1c, 0x42, 0x08, 0x90, 0x44, 0x8f, 0xc0, 0x0f, 0x07, 0x80,
		0x00, 0x4f, 0xe4, 0x00, 0x8b, 0x04, 0x94, 0x42, 0x48, 0x12, 0x64, 0xce, 0x40, 0x09, 0xfc, 0x80,
		0x00, 0x20, 0x08, 0x00, 0xf9, 0xff, 0xe7, 0xc3, 0xff, 0xff, 0xff, 0xfb, 0xc0, 0x04, 0x01, 0x00,
		0x00, 0x18, 0x30, 0x00, 0xf1, 0xff, 0xe7, 0x83, 0xff, 0xff, 0xff, 0xfb, 0xc0, 0x03, 0x06, 0x00,
		0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

void game_writeScore(uint16_t new_score, uint8_t game)
{
	switch (game)
	{
	case Game_Dino:
		eeprom_write_word(GAME_DINO_ADDR, new_score);
		break;
	case Game_Snake:
		eeprom_write_word(GAME_SNAKE_ADDR, new_score);
		break;
	case Game_Pong:
		eeprom_write_word(GAME_PONG_ADDR, new_score);
		break;
	default:
		break;
	}
}

uint16_t game_readScore(uint8_t game)
{
	switch (game)
	{
	case Game_Dino:
		return eeprom_read_word(GAME_DINO_ADDR);
	case Game_Snake:
		return eeprom_read_word(GAME_SNAKE_ADDR);
	case Game_Pong:
		return eeprom_read_word(GAME_PONG_ADDR);
	default:
		return 1;
	}
}

void game_clearAllScores(void)
{
	eeprom_write_word(GAME_DINO_ADDR, 0);
	eeprom_write_word(GAME_SNAKE_ADDR, 0);
	eeprom_write_word(GAME_PONG_ADDR, 0);
}

void game_drawMainMenu()
{
	static char buff[20];
	
	ssd1306_SetCursor(0, 0);
	ssd1306_WriteString("Select game:", Font_11x18, White);

	ssd1306_SetCursor(10, 20);
	ssd1306_WriteString("Dino", Font_7x10, White);
	ssd1306_SetCursor(60, 20);
	snprintf(buff, 20, "Top: %d", game_readScore(Game_Dino));
	ssd1306_WriteString(buff, Font_6x8, White);
	buff[0] = '\0';
	
	ssd1306_SetCursor(10, 30);
	ssd1306_WriteString("Snake", Font_7x10, White);
	ssd1306_SetCursor(60, 30);
	snprintf(buff, 20, "Top: %d", game_readScore(Game_Snake));
	ssd1306_WriteString(buff, Font_6x8, White);
	buff[0] = '\0';
	
	ssd1306_SetCursor(10, 40);
	ssd1306_WriteString("Pong", Font_7x10, White);
	ssd1306_SetCursor(60, 40);
	snprintf(buff, 20, "Top: %d", game_readScore(Game_Pong));
	ssd1306_WriteString(buff, Font_6x8, White);
	buff[0] = '\0';
	
	ssd1306_SetCursor(10, 50);
	ssd1306_WriteString("Debug", Font_7x10, White);
}

void game_drawSelector(game_selected_e selected_game)
{
	ssd1306_FillCircle(3, 24, 2, Black);
	ssd1306_FillCircle(3, 34, 2, Black);
	ssd1306_FillCircle(3, 44, 2, Black);
	ssd1306_FillCircle(3, 54, 2, Black);
	switch (selected_game)
	{
	case Game_Dino:
		ssd1306_FillCircle(3, 24, 2, White);
		break;
	case Game_Snake:
		ssd1306_FillCircle(3, 34, 2, White);
		break;
	case Game_Pong:
		ssd1306_FillCircle(3, 44, 2, White);
		break;
	case Game_Debug:
		ssd1306_FillCircle(3, 54, 2, White);
		break;
	default:
		break;
	}
}

game_selected_e game_mainMenuLoop()
{
	game_selected_e selected_game = Game_Dino;

	ssd1306_Fill(Black);
	game_drawMainMenu();
	while (1)
	{
		buttons_updateAll();

		if (button_getState3() == Button_Falling) // TODO define macro for button i.e. BUTTON_A
		{
			if (selected_game != Game_Debug) // Last game
			{
				selected_game++;
			}
		}

		if (button_getState1() == Button_Falling)
		{
			if (selected_game != Game_Dino) // First game
			{
				selected_game--;
			}
		}

		if (button_getState4() == Button_Falling)
		{
			return selected_game;
		}

		game_drawSelector(selected_game);
		ssd1306_UpdateScreen();
	}
}

void game_over(uint16_t score, uint8_t game)
{
	static char buff[20];
	uint8_t score_pos_x;
	
	ssd1306_Fill(Black);
	ssd1306_DrawBitmap(0, 0, game_over_bmp, SSD1306_WIDTH, SSD1306_HEIGHT, White);
	
	if (score < 10)
	{
		score_pos_x = GAME_SCORE_X0;
	}
	else if (score < 100)
	{
		score_pos_x = GAME_SCORE_X1;
	}
	else if (score < 1000)
	{
		score_pos_x = GAME_SCORE_X2;
	}
	else if (score < 10000)
	{
		score_pos_x = GAME_SCORE_X3;
	}
	else
	 {
		score_pos_x = GAME_SCORE_X4;
	}
	
	snprintf(buff, 20, "%d", score);
	ssd1306_SetCursor(score_pos_x, GAME_SCORE_Y);
	ssd1306_WriteString(buff, Font_11x18, White);
	
	if (score > game_readScore(game))
	{
		game_writeScore(score, game);
	}

	ssd1306_UpdateScreen();
	while (!(
		button_getState1() == Button_Falling ||
		button_getState2() == Button_Falling ||
		button_getState3() == Button_Falling ||
		button_getState4() == Button_Falling))
	{
		buttons_updateAll();
	};
}
